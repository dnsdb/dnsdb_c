.\" Copyright (c) 2014-2017 by Farsight Security, Inc.
.\"
.\" Licensed under the Apache License, Version 2.0 (the "License");
.\" you may not use this file except in compliance with the License.
.\" You may obtain a copy of the License at
.\"
.\"  http://www.apache.org/licenses/LICENSE-2.0
.\"
.\" Unless required by applicable law or agreed to in writing, software
.\" distributed under the License is distributed on an "AS IS" BASIS,
.\" WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
.\" See the License for the specific language governing permissions and
.\" limitations under the License.
.\"
.Dd 2017-01-19
.Dt dnsdb_query 1 DNSDB
.Os " "
.Sh NAME
.Nm dnsdb_query
.Nd DNSDB query tool
.Sh SYNOPSIS
.Op Fl dfhjv
.Op Fl A Ar timestamp
.Op Fl B Ar timestamp
.Op Fl b Ar bailiwick
.Op Fl r Ar rdata
.Op Fl n Ar name
.Op Fl i Ar ip
.Op Fl l Ar limit
.Op Fl p Ar output_type
.Op Fl t Ar type
.Op batch_filename
.Sh DESCRIPTION
.Nm dnsdb_query
constructs and issues queries to the Farsight DNSDB and displays responses.

DNSDB is a database that stores and indexes both the passive DNS data
available via Farsight Security's Security Information Exchange as well as the
authoritative DNS data that various zone operators make available. DNSDB makes
it easy to search for individual DNS RRsets and provides additional metadata
for search results such as first seen and last seen timestamps as well as the
DNS bailiwick associated with an RRset. DNSDB also has the ability to perform
inverse or rdata searches.

A Farsight Security-provisioned apikey is required for identification and
authentication.
.Ss OPTIONS
The following arguments are available:
.Bl -tag -width 3n
.It Fl A Ar timestamp
Specify a "time_first_after" timestamp. Only results first seen on or after
this date will be emitted. Expects timestamp to be of
the absolute form:
.Ic YYYY-DD-MM[ HH:MM:SS]
or the relative form:
.Ic %dw%dd%dh%dm%ds.
.It Fl B Ar timestamp
Specify a "time_first_before" timestamp. Only results first seen on or before
this date will be emitted. Expects timestamp to be of
the absolute form:
.Ic YYYY-DD-MM[ HH:MM:SS]
or the relative form:
.Ic %dw%dd%dh%dm%ds.
.It Fl b Ar bailiwick
specify bailiwick (only valid with
.Fl r
queries).
.It Fl d
enable debug mode.
.It Fl f
specify batch lookup allowing one or more queries to be performed. Queries
should be specified in a file and each should be of the following format:

.Bl -enum -offset indent
.It
RRSet query:
.Ic rrset/name/NAME[/TYPE[/BAILIWICK]]
.It
Rdata (name) query:
.Ic rdata/name/NAME[/TYPE]
.It
Rdata (IP address) query:
.Ic rdata/ip/ADDR[/PFXLEN]
.El

This option cannot be mixed with
.Fl n ,
.Fl r ,
or
.Fl i .
An example of how to use it is below.
.It Fl h
emit usage and quit.
.It Fl i Ar ip
specify rdata ip query.
.It Fl j
specify newline delimited json output mode.
.It Fl l Ar limit
clamp the number of responses to
.Ic limit .
.It Fl n Ar name
specify rdata name query.
.It Fl r Ar rdata
specify rrset query.
.It Fl p Ar output_type
select output type. Specify
.Ic csv
for comma separated value output,
.Ic dns
for presentation output similar to that of dig(1), or
.Ic json
for newline delimited json output.
.It Fl t Ar type
specify type of rdata query and how
.Ic value
specifies how the target value should be interpreted. Should be one of the
following:
.Bl -enum -offset indent
.It
.Ic name :
The
.Ic value
is a DNS domain name in presentation format, or a left-hand (".example.com")
or right-hand ("www.example.") wildcard domain name. Note that left-hand
wildcard queries are somewhat more expensive than right-hand wildcard queries.
.It
.Ic ip :
The
.Ic value
is one of an IPv4 address, an IPv6 address, an IPv4 network with prefix length,
or an IPv6 network with prefix length. If a network lookup is being performed,
the delimiter between network address and prefix length is a single comma (",")
character rather than the usual slash ("/") character to avoid clashing with
the HTTP URI path name separator.
.It
.Ic raw :
The
.Ic value
is an even number of hexadecimal digits specifying a raw octet string.
.El

.It Fl v
enable verbose mode.
.El
.Sh EXAMPLES
Perform an rrset query for a single A record for
.Ic farsightsecurity.com .
The output is serialized as JSON and is piped to the
.Ic jq
program for pretty printing.
.Bd -literal -offset 4n
$ dnsdb_query -r farsightsecurity.com/A -l 1 -j | jq .
{
  "count": 6350,
  "time_first": 1380123423,
  "time_last": 1427869045,
  "rrname": "farsightsecurity.com.",
  "rrtype": "A",
  "bailiwick": "farsightsecurity.com.",
  "rdata": [
    "66.160.140.81"
  ]
}

.Ed
Perform a batched operation for a several different
.Ic rrset
and
.Ic rdata
queries. Output is again serialized as JSON and redirected to a file.

.Bd -literal -offset 4n
$ cat batch.txt
rrset/name/\*.wikipedia.org
rrset/name/\*.dmoz.org
rdata/name/\*.pbs.org
rdata/name/\*.opb.org
rdata/ip/198.35.26.96
rdata/ip/23.21.237.247
$ dnsdb_query -j -f < batch.txt > batch-output.json
$ head -1 batch-output.json  | jq .
{
  "count": 2411,
  "zone_time_first": 1275401003,
  "zone_time_last": 1484841664,
  "rrname": "wikipedia.org.",
  "rrtype": "NS",
  "bailiwick": "org.",
  "rdata": [
    "ns0.wikimedia.org.",
    "ns1.wikimedia.org.",
    "ns2.wikimedia.org."
  ]
}
.Ed
.Sh FILES
.Ic ~/.dnsdb-query.conf :
configuration file which should contain the user's apikey, server URL, and at
some point, other configuration data.

.Bl -offset indent
.It
.Ic APIKEY :
contains the user's apikey (APIKEY=foo)
.It
.Ic SERVER :
contains the URL of the DNSDB API server (SERVER=https://api.dnsdb.info)
.El
.El
.Sh ENVIRONMENT VARIABLES
Optionally, the user can set the following environment variables which will
override configuration file options:

.Bl -offset indent
.It
.Ic DNSDB_API_KEY :
contains the user's apikey
.It
.Ic DNSDB_SERVER :
contains the URL of the DNSDB API server
.El
.Sh SEE ALSO
.Xr dig 1 ,
.Xr jq  1
